<template>
  <section v-if="generate">
    <div class="font2">
      <span class="font2-txt">æ—¶è‡³ä»Šæ—¥ï¼Œ</span>
      <span class="font2-txt">æˆ‘ä»¬çš„æ—…ç¨‹å·²ç»å¼€å§‹äº† {{ days }} å¤©ã€‚</span>
      <span class="font2-txt">ä½ çš„æ¯ä¸€æ¬¡æäº¤ã€æ¯ä¸€æ¬¡å‚èµ›ï¼Œ</span>
      <span class="font2-txt">éƒ½æ˜¯ä¸ä¼—ä¸åŒçš„å°è®°ã€‚</span>
      <span class="font2-txt">æ— æ•°çš„å°è®°ï¼Œæ–‘æ–“äº¤é”™ï¼Œ</span>
      <span class="font2-txt">å…±åŒç»„æˆäº†åä¸ºå›å¿†çš„çº½å¸¦ã€‚</span>
      <span class="font2-txt">å®ƒè¿ç»“èµ·å‘½å®šç›¸äº¤çš„æ—¶åˆ»ï¼Œ</span>
      <span class="font2-txt">å¹¶å»¶å‘å¯æœŸçš„æœªæ¥ã€‚</span>
      <span class="font2-txt">æ„¿æ—¶é—´ä¸ä½ å…±å†™ç¾æ¢¦ï¼Œ</span>
      <span class="font2-txt">æ„¿ç¥ç¦ä¼´ä½ ç»ˆæŠµäº‘é¡¶ã€‚</span>
      <span class="font2-txt">æ„Ÿè°¢é™ªä¼´ï¼</span>
    </div>
    <button class="btn" @click="gosum">ç‚¹å‡»ç”Ÿæˆä½ çš„ä¸“å± OJ å¹´æŠ¥ ğŸ¥³</button>
    <div class="sdutoj">
      <div class="font1">
        Practice coding, compete with players, and become a master.
      </div>
      <div class="bottom-icon">
        <img
          src="../assets/img/bLue.png"
          alt=""
          height="60%"
          style="position: relative; right: 0.2rem"
        />
        <p class="blue">bLue</p>
        <img
          src="../assets/img/and.png"
          alt=""
          height="50%"
          style="position: relative; right: 0.1rem"
        />
        <img src="../assets/img/qq.png" alt="" height="60%" />
        <p class="atrior">atrior</p>
        <div class="wline"></div>
        <img
          src="../assets/img/LCL_hero_dark.bfdc1ef6.png"
          alt=""
          height="100%"
          class="lcllab"
        />
        <div
          style="
            width: 100%;
            height: fit-content;
            position: absolute;
            bottom: 0;
            transform: translateY(1rem);
            color: gray;
            text-align: center;
            font-size: 0.1rem;
          "
        >
          BGMï¼šç°æ¾ˆ - åˆå
        </div>
      </div>

      <span ref="text1" class="chars">S</span>
      <span ref="text2" class="chars">D</span>
      <span ref="text3" class="chars">U</span>
      <span ref="text4" class="nc">T</span>
      <span ref="text5" class="nc">O</span>
      <span ref="text6" class="nc">J</span>
    </div>
  </section>
  <section v-else class="summ">
    <div class="sumarry" ref="sumarry">
      <span class="scanner">æ‰«ç æŸ¥çœ‹ 2025 ä¸“å±å¹´åº¦æŠ¥å‘Š</span>
      <lay-qrcode
        :width="93"
        :backgroundColor="'#ffffff00'"
        class="sum-qr"
        text="https://oj.sdutacm.cn/oj-annual-report-2025/?from=qr"
        style="background-color: transparent"
      ></lay-qrcode>
      <img
        src="../assets/img/sdutacm_logo_colorful-02a05aa9.svg"
        alt=""
        class="back"
      />

      <div class="results-summary-container">
        <div class="Iconfetti">
          <div class="confetti-piece"></div>
          <div class="confetti-piece"></div>
          <div class="confetti-piece"></div>
          <div class="confetti-piece"></div>
          <div class="confetti-piece"></div>
          <div class="confetti-piece"></div>
          <div class="confetti-piece"></div>
          <div class="confetti-piece"></div>
          <div class="confetti-piece"></div>
          <div class="confetti-piece"></div>
          <div class="confetti-piece"></div>
          <div class="confetti-piece"></div>
          <div class="confetti-piece"></div>
          <div class="confetti-piece"></div>
          <div class="confetti-piece"></div>
          <div class="confetti-piece"></div>
          <div class="confetti-piece"></div>
          <div class="confetti-piece"></div>
          <div class="confetti-piece"></div>
        </div>
        <div class="results-summary-container__result">
          <div class="heading-tertiary">
            æˆ‘çš„ SDUT OJ 2025 å¹´æŠ¥ <span>ğŸ¥³</span>
          </div>
          <div class="result-box">
            <img
              :src="`https://cdn.sdutacm.cn/oj/image/avatars/${avatar}`"
              alt=""
              style="border-radius: 50%"
            />
          </div>
          <div class="result-text-box">
            <div class="heading-secondary">{{ nickname }}</div>
            <div class="paragraph">
              <div class="ac-num">
                <p>
                  æ€»è®¡ AC <span>{{ allAc }}</span>
                </p>
                <p>
                  å¹´åº¦ AC <span>{{ newAc }}</span>
                </p>
                <p v-if="percent > 0" class="percent">Top {{ percentVal }}%</p>
              </div>
              <div class="ac-num">
                <div class="rating" v-if="false && showRating">
                  Rating
                  <span
                    class="rating-color"
                    :style="{
                      color:
                        userRating >= -1000 && userRating < 1200
                          ? '#969696'
                          : userRating >= 1200 && userRating < 1400
                          ? '#28C438'
                          : userRating >= 1400 && userRating < 1600
                          ? '#0099FF'
                          : userRating >= 1600 && userRating < 1900
                          ? '#C600FF'
                          : userRating >= 1900 && userRating < 2200
                          ? '#FF8212'
                          : userRating >= 2200 && userRating < 2500
                          ? '#F8BF29'
                          : userRating >= 2500 && userRating < 8000
                          ? '#FB0007'
                          : '',
                    }"
                  >
                    {{ userRating }}
                  </span>
                </div>

                <div class="achiv-num">
                  æ€»æˆå°±æ•° <span>{{ userAchieve }}</span>
                </div>

                <div class="days-num">
                  åŒè¡Œ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                  <span>{{ days }}</span> å¤©
                </div>
              </div>
              <div class="contests" v-if="haveContest">
                <li
                  v-for="(item, index) in contests"
                  :key="index"
                  class="bisai"
                >
                  <span>{{ item.title }}</span>
                  <span :class="item.medal ? `text-${item.medal}` : ''">{{
                    item.awardStr
                  }}</span>
                </li>
              </div>
            </div>
          </div>
          <div
            class="results-summary-container__options"
            :style="{ opacity: tags.length > 0 ? 1 : 0 }"
          >
            <div class="tag-head">2025 å›å¿†æ ‡ç­¾ âœ¨ï¸</div>
            <ul class="summary-result-options">
              <li v-for="(item, index) in tags" :key="index" class="tag">
                {{ item }}
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>
</template>

<script setup>
import {
  days,
  avatar,
  liuyang,
  musicStart,
  musicPlay,
  bgmMuted,
  bgmPlaying,
} from "@/assets/global";
let percent = liuyang.value.annualNewAcceptedTopPercent;
let percentVal = ref(Math.max(Math.floor(100 * percent), 1));
let allAc = liuyang.value.accepted;
let newAc = liuyang.value.annualNewAccepted;
let userRating = liuyang.value.rating;
const showRating = ref(true);
if (userRating === 0) {
  showRating.value = false;
}
let userAchieve = liuyang.value.achievements.length;
let nickname = liuyang.value.nickname;
import { ref, onMounted, nextTick } from "vue";
import html2canvas from "html2canvas";
import QRCode from "qrcode";
const text1 = ref(null);
const text2 = ref(null);
const text3 = ref(null);
const text4 = ref(null);
const text5 = ref(null);
const text6 = ref(null);
const ojoj = ref(null);
const generate = ref(true);

function gosum() {
  setTimeout(() => {
    generate.value = false;
  }, 600);
}
onMounted(() => {
  setTimeout(() => {
    nextTick(() => {
      let shadow = "";
      let shadow3 = "";
      let total = 10;
      for (let i = 1; i <= total; i++) {
        shadow += `-${i}px ${i}px #c2c2c2,`;
      }
      for (let i = 1; i <= total; i++) {
        shadow3 += `${i}px ${i}px #c2c2c2,`;
      }
      shadow = shadow.slice(0, -1);
      shadow3 = shadow3.slice(0, -1);

      if (text1.value) text1.value.style.textShadow = shadow;
      if (text2.value) text2.value.style.textShadow = shadow;
      if (text3.value) text3.value.style.textShadow = shadow;
      if (text4.value) text4.value.style.textShadow = shadow3;
      if (text5.value) text5.value.style.textShadow = shadow3;
      if (text6.value) text6.value.style.textShadow = shadow3;

      const charsanimation = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              setTimeout(() => {
                entry.target.classList.add("charsanim");
                const title = document.querySelector(".title");
                title.classList.remove("fontactive");
              }, 30000);
            } else {
              entry.target.classList.remove("charsanim");
            }
          });
        },
        { threshold: 0.1 }
      );

      const fontanimation = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              setTimeout(() => {
                entry.target.classList.add("font1anim");
              }, 29000);
            } else {
              entry.target.classList.remove("font1anim");
            }
          });
        },
        { threshold: 0.1 }
      );

      const font2animation = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              musicPlay.value = false;
              musicStart.value = false;
              const font2txt = document.querySelectorAll(".font2-txt");
              font2txt.forEach(function (currentValue, index, array) {
                if (index === array.length - 1) {
                  currentValue.classList.add("font2Lastanim");
                } else {
                  currentValue.classList.add("font2anim");
                }
              });
              setTimeout(() => {
                entry.target.classList.add("remove");
              }, 27000);
              setTimeout(() => {
                const sdutoj = document.querySelector(".sdutoj");
                sdutoj.classList.add("sdutojanim");
                const btn = document.querySelector(".btn");
                btn.classList.add("sdutojanim");
              }, 30000);
            }
          });
        },
        { threshold: 0.1 }
      );

      const bottomIconanim = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              setTimeout(() => {
                entry.target.classList.add("btm-logo");
              }, 30000);
            } else {
              entry.target.classList.remove("btm-logo");
            }
          });
        },
        { threshold: 0.1 }
      );
      const chars = document.querySelectorAll(".chars, .nc");
      chars.forEach((char) => {
        charsanimation.observe(char);
      });
      const fonts = document.querySelector(".font1");
      fontanimation.observe(fonts);
      const font2s = document.querySelector(".font2");
      font2animation.observe(font2s);

      const bottomIcon = document.querySelector(".bottom-icon");
      bottomIconanim.observe(bottomIcon);
    });
  }, 100);
});
const generateQRCode = async (text) => {
  try {
    const qrCodeDataUrl = await QRCode.toDataURL(text, {
      width: 200, // æ§åˆ¶äºŒç»´ç çš„å¤§å°
      margin: 1, // æ§åˆ¶äºŒç»´ç çš„è¾¹è·
      color: {
        dark: "#000000", // äºŒç»´ç çš„é¢œè‰²
        light: "#ffffff00", // èƒŒæ™¯é¢œè‰²
      },
    });
    return qrCodeDataUrl;
  } catch (error) {
    console.error("ç”ŸæˆäºŒç»´ç å¤±è´¥", error);
  }
};
const downloadAsImage = async () => {
  if (sumarry.value) {
    try {
      const qrCodeDataUrl = await generateQRCode(
        "https://oj.sdutacm.cn/oj-annual-report-2025"
      );
      html2canvas(sumarry.value, {
        useCORS: true, // å¯ç”¨è·¨åŸŸæ”¯æŒ
        scale: 2, // æå‡å›¾ç‰‡åˆ†è¾¨ç‡
      }).then((canvas) => {
        const ctx = canvas.getContext("2d");

        // ç­‰å¾…äºŒç»´ç å›¾ç‰‡åŠ è½½å®Œæˆ
        const img = new Image();
        img.src = qrCodeDataUrl;
        img.onload = () => {
          // åœ¨ Canvas ä¸Šç»˜åˆ¶äºŒç»´ç ï¼Œè®¾ç½®ä½ç½®å’Œå¤§å°
          const qrSize = 100; // äºŒç»´ç çš„å¤§å°
          ctx.drawImage(
            img,
            canvas.width - qrSize - 20,
            canvas.height - qrSize - 20,
            qrSize,
            qrSize
          ); // åœ¨å³ä¸‹è§’ç»˜åˆ¶äºŒç»´ç 

          // å°†ä¿®æ”¹åçš„ Canvas è½¬æ¢ä¸ºå›¾ç‰‡ URL
          const imageUrl = canvas.toDataURL("image/png");

          // åˆ›å»ºä¸‹è½½é“¾æ¥å¹¶è§¦å‘ä¸‹è½½
          const link = document.createElement("a");
          link.href = imageUrl;
          link.download = "screenshot_with_qrcode.png";
          link.click();
        };
      });
    } catch (error) {
      console.error("ç”ŸæˆäºŒç»´ç æˆ–æˆªå›¾å¤±è´¥", error);
    }
  } else {
    console.log("null");
  }
};

const sumarry = ref(null);

const tags = ref([]);

if (liuyang.value.annualNewAccepted >= 100) {
  tags.value.push("åˆ·é¢˜ç‹");
}
if (liuyang.value.nightWalker) {
  tags.value.push("å¤œçŒ«å­");
}
if (liuyang.value.maxTries) {
  tags.value.push("ç™¾æŠ˜ä¸æŒ ");
}
if (liuyang.value.competition.asGenshin) {
  tags.value.push("åŸç¥å¯åŠ¨!");
}
if (liuyang.value.competition.sdutpc17) {
  tags.value.push("æ ¡èµ›è§è¯è€…");
}
if (liuyang.value.competition.sdutnc7th) {
  tags.value.push("åˆå‡æ–°æ˜Ÿ");
}
if (liuyang.value.competition.sdutpmc17th) {
  tags.value.push("é˜Ÿä¼çš„ç¾ç»Š");
}

const contests = ref([]);
const haveContest = ref(false);
if (liuyang.value.competition.attendedCompetitionCount > 0) {
  haveContest.value = true;
  contests.value = liuyang.value.competition.attendedCompetitions;
}
</script>

<style scoped>
@import url("../assets/sumarry.css");
@import url("../assets/last.css");
section {
  position: absolute;
  top: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  height: 100vh;
  overflow: hidden;
  transition: all 0.3s linear;
}
.remove {
  opacity: 0;
}
.btm-logo {
  animation: opop ease 1s forwards;
  animation-delay: 7.5s;
}

.animrunning {
  animation-play-state: running;
}

@keyframes opop {
  100% {
    opacity: 1;
  }
}
.sdutojanim {
  opacity: 1;
  filter: blur(0);
  animation: upmove 1.5s ease forwards;
  animation-delay: 7.5s;
}

@keyframes upmove {
  from {
    transform: translateY(0);
  }
  to {
    transform: translateY(-2rem);
  }
}

.summ {
  opacity: 1 !important;
  transition: all 0.5s ease-in-out;
  transform: translateY(0) !important;
}
</style>
